{% extends "panel/base.html" %}
{% block title %}{{ release }}{% endblock %}
{% block content %}
<div class="container">
    <h2>Release {{ release }}</h2>
    <div class="panel panel-default stats"></div>
    <div class="panel panel-default project-clone hidden">
        <div class="panel-heading">
            <h3 class="panel-title"></h3>
        </div>
        <div class="panel-body">
            <div class="panel panel-default hidden uuid-clone">
                <div class="panel-heading">
                    <h3 class="panel-title"></h3>
                </div>
                <div class="panel-body">
                    <ul class="list-group list-inline uuid-list">
                        <li class="list-group-item hidden job"></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="panel-footer error"></div>
    </div>
    <div id="project-list"></div>
</div>
{% endblock %}

{% block extrajs %}
<script type="text/javascript">
$.release = {projects: new Set(), interval: 15000,};

function get_class_status(base, status) {
    var result = base;
    switch (status) {
      case "SUCCESS":
        result += "success";
        break;
      case "UNSTABLE":
        result += "warning";
        break;
      default:
        result += "danger";
    }
    return result;
}

function set_project_status(project, value) {
  var div_project = $('#' + project);
  var div_uuid = $('.uuid:first', div_project);

  console.debug('set_project_status');

  if (value) {
    var status = value.result;
    div_project.addClass(get_class_status("panel-", status));
  }
  else {
    console.debug('uuid that counts: ' + div_uuid.attr('id'));
    if (div_uuid.hasClass('panel-warning')) {
      div_project.addClass('panel-warning');
    }
    else if (div_uuid.hasClass('panel-danger')) {
      div_project.addClass('panel-danger');
    }
    else if (div_uuid.hasClass('panel-success')) {
      div_project.addClass('panel-success');
    }
  }
}

function set_uuid_status(project, uuid, job, value) {
  var div_uuid = $('#' + project + '-' + uuid);
  var status = value.result;
  var _class = get_class_status("panel-", status);

  switch (status) {
    case "SUCCESS":
    case "UNSTABLE":
      if (job.match(/.+-repos$/)) {
        div_uuid.removeClass('panel-warning panel-danger').addClass(_class);
        console.debug(project + ' uuid: ' + uuid + " OK. done");
      }
      else {
        console.debug(job + ' nothing to do here.');
      }
      break;
    default:
      div_uuid.addClass(_class);
      if(! $.release[project][uuid].failed) {
        $.release[project][uuid].failed = true;
        console.debug(project + ' uuid: ' + uuid + ' set failed');
      }
      set_project_status(project, value);
  }
}

function set_job_status(project, uuid, job, value) {
  var id = project + '-' + uuid + '-' + job;
  var div_job = $('#' + id);

  if (value) {
    console.debug(job + ' found');
    div_job.addClass(get_class_status("list-group-item-", value.result));
    div_job.html('<a href="' + value.job_url + value.buildnumber
      + '">' + job + '</a>');
  }
  else {
    console.error(job + ' not found');
    // this should not happend!!
  }
}

function create_new_job(project, uuid, job) {
  var id = project + '-' + uuid;
  var div_job = $('#' + id + '-job').clone().removeClass('hidden');

  div_job.attr('id', id + '-' + job).html(job);
  // put it on the proper place
  div_job.appendTo('#' + id + '-list');
  console.debug('job ' + job + ' created for ' + project + ' uuid: ' + uuid);
}

/**
 * The idea is to have a hidden blocks to clone
 * be sure to create proper ids and remove the classes
 * you use to select them
 */
function create_new_uuid_panel(project, uuid) {
  var id = project + '-' + uuid;
  var div_uuid = $('#' + project +' > .panel-body .uuid-clone').clone();
  div_uuid.removeClass('hidden');
  div_uuid.attr('id', id).removeClass('uuid-clone').addClass('uuid');

  // rest of blocks or classes to select inside this
  $('.uuid-list', div_uuid).attr('id', id + '-list').removeClass('uuid-list');
  $('.job', div_uuid).attr('id', id + '-job').removeClass('job');

  var div_title = $('.panel-heading > .panel-title', div_uuid);
  div_title.html(uuid);

  // put it on the proper place
  div_uuid.appendTo('#' + project + ' > .panel-body');
  console.debug('uuid ' + uuid + ' created for ' + project);
}

function create_new_project_panel(project) {
  var div_project = $('.project-clone').clone();
  div_project.removeClass('hidden');
  div_project.attr('id', project).removeClass('project-clone').addClass('project');

  var div_title = $('.panel-heading > .panel-title', div_project);
  div_title.html(project);

  $('.error', div_project).attr('id', project + '-error').removeClass('error');
  div_project.appendTo('#project-list');
  console.debug('project ' + project + ' created');
}
/******************************************************************/

function update_job_view(project, uuid, job, data) {
  var value = data.results[0];

  set_job_status(project, uuid, job, value);

  if (data.count != 0) {
    if ($.release[project][uuid][job].timer) {
      clearInterval($.release[project][uuid][job].timer);
      console.debug("clearInterval uuid: "+ uuid + ' ' + job);
    }
    set_uuid_status(project, uuid, job, value);
  }
  else {
    console.error(job + ' not found');
    // this should not happend!!
  }
}

function update_job_info(release, project, uuid, job) {

  function successFunc(data, textStatus, jqXHR ) {
    update_job_view(project, uuid, job, data);
  }

  function errorFunc(jqXHR, status, error) {
    $('#' + project + '-error').html(error);
    $.release[project][uuid][job].failed = true;
  }

  if (! $.release[project][uuid].failed) {
    if (! $.release[project][uuid][job].failed ) {
      $.ajax({
        url: '/jenkinsbuildinfo/?format=json&tag=' + uuid
          + '&param_release={{ release}}&jobname=' + job,
        method: 'GET',
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: successFunc,
        error: errorFunc
      });
    }
    else {
      console.debug('uuid: ' + uuid + ' job: ' + job + ' already failed');
    }
  }
  else {
    console.debug(project + ' uuid: ' + uuid + ' already failed');
    clearInterval($.release[project][uuid][job].timer);
    console.debug("clearInterval uuid:" + uuid + ' ' + job);
    set_project_status(project, {result: "FAILED"});
  }
}

function update_uuid_info(release, project, uuid) {

  function successFunc(data, textStatus, jqXHR ) {
    $(data).each(function() {
      var job = this.jobname;
      $.release[project][uuid].jobs.add(job);

      if (! $.release[project][uuid][job]) {
        $.release[project][uuid][job] = { failed: false, };
        create_new_job(project, uuid, job);
        update_job_info(release, project, uuid, job);
      }

      if (! $.release[project][uuid][job].failed) {
        if (! $.release[project][uuid][job].timer) {
          $.release[project][uuid][job].timer = setInterval(function() {
            update_job_info(release, project, uuid, job); }, $.release[project].interval);
          console.debug('uuid: ' + uuid +
            ' new job: ' + job +' setInterval ' + $.release[project].interval);
        }
      }
      else {
        console.debug('uuid: ' + job +' already failed');
      }
    });
  }

  function errorFunc(jqXHR, status, error) {
    $('#' + project + '-error').html(error);
    $.release[project][uuid].failed = true;
  }

  if (! $.release[project][uuid].failed) {
    $.ajax({
      url: '/release/{{ release }}/' + project + '/' + uuid + '/?format=json',
      method: 'GET',
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: successFunc,
      error: errorFunc
    });
  }
  else {
    console.debug(project + 'uuid ' + uuid +' already failed');
    clearInterval($.release[project][uuid].timer);
  }
}

function get_uuids_for_project(release, project) {

  function successFunc(data, textStatus, jqXHR ) {
    $(data).each(function() {
      var uuid = this.tag;
      if (uuid == null) {
        console.warn(project + " skip null uuid");
        return;
      }
      if ($.release[project].uuids.has(uuid)) {
        return;
      }
      $.release[project].uuids.add(uuid);
      if (! $.release[project][uuid] ) {
        $.release[project][uuid] = { failed: false, jobs: new Set(),};
        create_new_uuid_panel(project, uuid);
        update_uuid_info(release, project, uuid);
      }
      if (! $.release[project][uuid].failed ) {
        if (! $.release[project][uuid].timer) {
          $.release[project][uuid].timer = setInterval(function() {
            update_uuid_info(release, project, uuid); }, $.release[project].interval);
          console.debug(project + ' new uuid: ' + uuid +
            ' setInterval ' + $.release[project].interval);
        }
      }
      else {
        console.debug(project + ' uuid: ' + uuid +' already failed');
        clearInterval($.release[project][uuid].timer);
        console.debug(project + " clearInterval: " + uuid);
        set_project_status(project, {result: "FAILED"});
      }
    });
  }

  function errorFunc(jqXHR, status, error) {
    $('#' + project + '-error').html(error);
    $.release[project].failed = true;
  }

  $.ajax({
    url: '/release/{{ release }}/' + project + '/?format=json',
    method: 'GET',
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: successFunc,
    error: errorFunc
  });
}

function get_projects(release) {

  function successFunc(data, textStatus, jqXHR ) {
    $(data).each(function() {
      var project = this.projectname;
      if ($.release[project]) {
        return;
      }
      $.release.projects.add(project);
      if (! $.release[project] ) {
        $.release[project] = {uuids: new Set(), failed: false, interval: 5000,};
        create_new_project_panel(project);

        $.release[project].timer = setInterval(function() {
          get_uuids_for_project(release, project);
        }, $.release[project].interval);
        console.log(project + ' get uuids setInterval '
          + $.release[project].interval);
        get_uuids_for_project(release, project);
      }
    });
  }

  function errorFunc(jqXHR, status, error) {
    console.error(error);
  }

  $.ajax({
    url: '/release/' + release + '/?format=json',
    method: 'GET',
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: successFunc,
    error: errorFunc
  });
}

$( document ).ready(function() {
  $.release.timer = setInterval(function(){
    get_projects('{{release}}');
  }, $.release.interval);
  console.debug('projects set interval to ' + $.release.interval);
  get_projects('{{release}}');
});
</script>
{% endblock %}
